// Access contribution data passed from the template
const contributionsData = JSON.parse(document.getElementById('contributions-data').textContent);

// Populate the contributions table
const contributionsTable = document.querySelector('#contributions-table tbody');

console.log('Contributions Data:', contributionsData);
contributionsData.forEach(contribution => {

  console.log('Contribution object:', contribution);

  // Convert contribution to plain dict
  const contributionDict = {
    contribution_reference: contribution.contribution_reference,
    contributor_name: contribution.contributor_name,
    amount: contribution.amount,
    contribution_date: contribution.contribution_date,
    contribution_time: contribution.contribution_time,
    timestamp: contribution.timestamp
  };

  console.log('Contribution dict:', contributionDict);


  // Format amount as currency
  contributionDict.amount = contributionDict.amount.toLocaleString('en-KE', {
    style: 'currency',
    currency: 'KES'
  });

  // Format dates
  contributionDict.contribution_date = contributionDict.contribution_date.toLocaleDateString();
  contributionDict.contribution_time = contributionDict.contribution_time.toLocaleTimeString();

  // Create row
  const row = document.createElement('tr');

  // Insert dict data into row
  row.innerHTML = `
    <td>${contributionDict.contribution_reference}</td>
    <td>${contributionDict.contributor_name}</td>
    <td>${contributionDict.amount}</td> 
    <td>${contributionDict.contribution_date}</td>
    <td>${contributionDict.contribution_time}</td>
    <td>${contributionDict.timestamp}</td>
  `;

  // Add row to table
  contributionsTable.appendChild(row);
});

// Print contributionsData again after loop
console.log('Contributions Data:', contributionsData);

// Implement PDF download functionality
const downloadPdfButton = document.querySelector('#download-pdf');
downloadPdfButton.addEventListener('click', () => {
  const doc = new jsPDF();

  // Add header
  doc.setHeader({
    html: `
    <h1>Fundraiser Report</h1>
    <p>Fundraiser: ${fundraiser.name}</p>
    <p>Generated on: ${new Date().toLocaleDateString()}</p>
    `
  });

  // Add footer (will be repeated on every page)
  doc.setFooter({
    html: `
      <p>Page ${doc.internal.getNumberOfPages()}</p>
      <p>Generated by https://www.toa.co.ke</p>
    `
  });

  const table = document.querySelector('#contributions-table');
  doc.html(table, {
    callback: (doc) => {
      doc.save('contributions.pdf');
    }
  });
});
