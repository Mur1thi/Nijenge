import jsPDF from 'jspdf';
window.addEventListener('DOMContentLoaded', () => {
  // Access contribution data passed from the template
  const contributionsData = JSON.parse(document.getElementById('contributions-data').textContent);

  // Populate the contributions table
  const contributionsTable = document.querySelector('#contributions-table tbody');

  contributionsData.forEach(contribution => {
    // Check for duplicate reference before appending
    if (!contributionsTable.querySelector(`[data-contribution-reference="${contribution.contribution_reference}"]`)) {
      const formattedContribution = { ...contribution }; // Create a copy for formatting

      // Format amount as currency
      formattedContribution.amount = formattedContribution.amount.toLocaleString('en-KE', {
        style: 'currency',
        currency: 'KES'
      });

      // Format dates
      try {
        formattedContribution.contribution_date = new Date(contribution.contribution_date).toLocaleDateString();
        formattedContribution.contribution_time = new Date(contribution.contribution_time).toLocaleTimeString();
      } catch (error) {
        console.error('Error parsing date:', error);
        // Handle the error as needed
      }

      // Create table row
      const contributionRow = document.createElement('tr');
      contributionRow.innerHTML = `
        <td>${formattedContribution.contribution_reference}</td>
        <td>${formattedContribution.contributor_name}</td>
        <td>${formattedContribution.amount}</td>
        <td>${formattedContribution.contribution_date}</td>
        <td>${formattedContribution.contribution_time}</td>
        <td>${formattedContribution.timestamp}</td>
      `;
    }
  });

  // Implement PDF download functionality
  try {
    const downloadPdfButton = document.querySelector('#download-pdf');
    if (downloadPdfButton) {
      downloadPdfButton.addEventListener('click', () => {
        let html, internal, setFooter, setHeader;
        ({html, internal, setFooter, setHeader} = new jsPDF());

        // Add header (ensure fundraiser variable is available here)
        setHeader({
          html: `
            <h1>Fundraiser Report</h1>
            <p>Fundraiser: ${fundraiser.name}</p>  <p>Generated on: ${new Date().toLocaleDateString()}</p>
          `
        });

        // Add footer (will be repeated on every page)
        setFooter({
          html: `
            <p>Page ${internal.getNumberOfPages()}</p>
            <p>Generated by https://www.toa.co.ke</p>
          `
        });

        const table = document.querySelector('#contributions-table');
        html(table, {
          callback: (doc) => {
            doc.save('contributions.pdf');
          }
        });
      });
    } else {
      console.warn('Button with ID #download-pdf not found. PDF download functionality disabled.');
    }
  } catch (error) {
    console.error('Error with PDF download functionality:', error);
  }
});
